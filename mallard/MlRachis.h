/*
 *  MlRachis.h
 *  mallard
 *
 *  Created by jian zhang on 9/20/13.
 *  Copyright 2013 __MyCompanyName__. All rights reserved.
 *
 */

#pragma once
#include <AllMath.h>

class CollisionRegion;

class MlRachis {
public:
	MlRachis();
	~MlRachis();
	
	void create(unsigned x);
	void computeLengths(float * segL, float fullL);
	void reset();
	void bend();
	void bend(unsigned faceIdx, float patchU, float patchV, const Vector3F & oriP, const Matrix33F & space, float radius, CollisionRegion * collide);
	void pitchAndCurl(const float & pitchAngle, const float & curlAngle);
	Matrix33F getSpace(short idx) const;
	Float2 * angles() const;
	float bendDirection() const;
private:
	char isInside(const Vector3F & t, const Vector3F & onp, const Vector3F & nor);
	float bouncing(const Vector3F & a, const Vector3F & b, const Vector3F & c);
	float distanceFactor(const Vector3F & a, const Vector3F & b, const Vector3F & c);
	float pushToSurface(const Vector3F & wv, const Matrix33F & space);
	Float3 matchNormal(const Vector3F & wv, const Matrix33F & space);
	void moveForward(const Matrix33F & space, float distance, Vector3F & dst);
	void rotateForward(const Matrix33F & space, Matrix33F & dst);
	unsigned m_numSpace;
	Matrix33F * m_spaces;
	Float2 * m_angles;
	float * m_lengths;
	float * m_lengthPortions;
	float m_bendDirection;
};